<script>
    const params = new URLSearchParams(window.location.search);
    const productId = params.get("product") || "1005007292854280";
    const affTag = "cQ1BCFEo";
    const workerBase = "https://lp.jevri-kurnia.workers.dev/?id=";

    function cleanTitle(title) {
      return title.replace(/\s*[-|【(（]?AliExpress.*$/i, "").trim();
    }

    async function loadProduct(id) {
      const res = await fetch(workerBase + id);
      const data = await res.json();

      const titleClean = cleanTitle(data.title);
      document.title = titleClean;

      document.getElementById("mainImage").src = data.image;
      document.getElementById("title").innerText = titleClean;
      document.getElementById("buyBtn").href = data.buy_url + "?aff_fcid=" + affTag;
    }

    function loadRating() {
      const rating = (4 + Math.random()).toFixed(1);
      document.getElementById("rating").innerText = "⭐".repeat(~~rating) + (rating % 1 >= 0.5 ? "½" : "") + ` (${rating}/5)`;
    }

    function startCountdown(durationMinutes) {
      const endTime = Date.now() + durationMinutes * 60 * 1000;
      const countdownEl = document.getElementById("countdown");

      function update() {
        const now = Date.now();
        const diff = endTime - now;

        if (diff <= 0) {
          countdownEl.innerText = "Hurry! Almost gone!";
          return;
        }

        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        countdownEl.innerText = `Ends in: ${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        requestAnimationFrame(update);
      }

      update();
    }

    // Function to parse CSV data
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      
      return lines.slice(1).filter(line => line.trim() !== '').map(line => {
        const values = line.split(',');
        const item = {};
        headers.forEach((header, i) => {
          item[header] = values[i] ? values[i].trim() : '';
        });
        return item;
      });
    }

    // Modified loadRelated function to use data.csv
    async function loadRelated() {
      try {
        // Load CSV data
        const response = await fetch('data.csv');
        const csvText = await response.text();
        const products = parseCSV(csvText);
        
        // Filter out current product and get random 6 products
        const filtered = products.filter(item => item.ItemId !== productId);
        const shuffled = [...filtered].sort(() => 0.5 - Math.random());
        const relatedProducts = shuffled.slice(0, 6);
        
        // Clear existing content
        const relatedList = document.getElementById("relatedList");
        relatedList.innerHTML = '';
        
        // Add related products
        for (const product of relatedProducts) {
          const card = document.createElement("div");
          card.className = "related-card";
          card.innerHTML = `
            <div class="badge">New</div>
            <img src="${product.Image1}" alt="${product.Title}" onerror="this.src='https://via.placeholder.com/150'">
            <div class="title">${cleanTitle(product.Title)}</div>
            <a href="${product.Promote_Url}">Lihat</a>
          `;
          relatedList.appendChild(card);
        }
      } catch (e) {
        console.error("Failed to load related products:", e);
        document.getElementById("relatedList").innerHTML = '<p>Error loading related products</p>';
      }
    }

    // Run all
    loadProduct(productId);
    loadRating();
    startCountdown(60);
    loadRelated(); // Changed to call without parameters
  </script>
